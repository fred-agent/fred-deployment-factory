apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-sql
  labels:
    {{- include "fred-stack.labels" . | nindent 4 }}
data:
  001-init.sql: |
    DO $$
    BEGIN
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '{{ .Values.auth.postgresKeycloakUser }}') THEN
        CREATE ROLE {{ .Values.auth.postgresKeycloakUser }} NOSUPERUSER LOGIN PASSWORD '{{ .Values.auth.postgresKeycloakPassword }}';
      END IF;
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '{{ .Values.auth.postgresFredUser }}') THEN
        CREATE ROLE {{ .Values.auth.postgresFredUser }} NOSUPERUSER LOGIN PASSWORD '{{ .Values.auth.postgresFredPassword }}';
      END IF;
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '{{ .Values.auth.postgresTabularUser }}') THEN
        CREATE ROLE {{ .Values.auth.postgresTabularUser }} NOSUPERUSER LOGIN PASSWORD '{{ .Values.auth.postgresTabularPassword }}';
      END IF;
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '{{ .Values.auth.postgresOpenfgaUser }}') THEN
        CREATE ROLE {{ .Values.auth.postgresOpenfgaUser }} NOSUPERUSER LOGIN PASSWORD '{{ .Values.auth.postgresOpenfgaPassword }}';
      END IF;
      IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = '{{ .Values.auth.postgresTemporalUser }}') THEN
        CREATE ROLE {{ .Values.auth.postgresTemporalUser }} NOSUPERUSER LOGIN PASSWORD '{{ .Values.auth.postgresTemporalPassword }}';
      END IF;
    END
    $$;

    SELECT 'CREATE DATABASE {{ .Values.auth.postgresKeycloakDb }} OWNER {{ .Values.auth.postgresKeycloakUser }}'
      WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .Values.auth.postgresKeycloakDb }}')\gexec
    SELECT 'CREATE DATABASE {{ .Values.auth.postgresFredDb }} OWNER {{ .Values.auth.postgresFredUser }}'
      WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .Values.auth.postgresFredDb }}')\gexec
    SELECT 'CREATE DATABASE {{ .Values.auth.postgresTabularDb }} OWNER {{ .Values.auth.postgresTabularUser }}'
      WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .Values.auth.postgresTabularDb }}')\gexec
    SELECT 'CREATE DATABASE {{ .Values.auth.postgresOpenfgaDb }} OWNER {{ .Values.auth.postgresOpenfgaUser }}'
      WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .Values.auth.postgresOpenfgaDb }}')\gexec
    SELECT 'CREATE DATABASE {{ .Values.auth.postgresTemporalDb }} OWNER {{ .Values.auth.postgresTemporalUser }}'
      WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .Values.auth.postgresTemporalDb }}')\gexec
    SELECT 'CREATE DATABASE {{ .Values.auth.postgresTemporalVisibilityDb }} OWNER {{ .Values.auth.postgresTemporalUser }}'
      WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '{{ .Values.auth.postgresTemporalVisibilityDb }}')\gexec

    REVOKE ALL ON DATABASE {{ .Values.auth.postgresKeycloakDb }} FROM PUBLIC;
    GRANT CONNECT ON DATABASE {{ .Values.auth.postgresKeycloakDb }} TO {{ .Values.auth.postgresKeycloakUser }};
    REVOKE ALL ON DATABASE {{ .Values.auth.postgresFredDb }} FROM PUBLIC;
    GRANT CONNECT ON DATABASE {{ .Values.auth.postgresFredDb }} TO {{ .Values.auth.postgresFredUser }};
    REVOKE ALL ON DATABASE {{ .Values.auth.postgresTabularDb }} FROM PUBLIC;
    GRANT CONNECT ON DATABASE {{ .Values.auth.postgresTabularDb }} TO {{ .Values.auth.postgresTabularUser }};
    REVOKE ALL ON DATABASE {{ .Values.auth.postgresOpenfgaDb }} FROM PUBLIC;
    GRANT CONNECT ON DATABASE {{ .Values.auth.postgresOpenfgaDb }} TO {{ .Values.auth.postgresOpenfgaUser }};
    REVOKE ALL ON DATABASE {{ .Values.auth.postgresTemporalDb }} FROM PUBLIC;
    GRANT CONNECT ON DATABASE {{ .Values.auth.postgresTemporalDb }} TO {{ .Values.auth.postgresTemporalUser }};
    REVOKE ALL ON DATABASE {{ .Values.auth.postgresTemporalVisibilityDb }} FROM PUBLIC;
    GRANT CONNECT ON DATABASE {{ .Values.auth.postgresTemporalVisibilityDb }} TO {{ .Values.auth.postgresTemporalUser }};

    \connect {{ .Values.auth.postgresFredDb }}
    CREATE EXTENSION IF NOT EXISTS vector;

    \connect {{ .Values.auth.postgresTabularDb }}
    CREATE EXTENSION IF NOT EXISTS vector;
